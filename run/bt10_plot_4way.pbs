#!/bin/bash
#PBS -N bt10_plot_4way
#PBS -q normal
#PBS -P personal
#PBS -l select=1:ncpus=4:mem=16gb
#PBS -l walltime=00:20:00
#PBS -j oe
#PBS -o /scratch/users/ntu/shuyan00/nscc_qwen/logs/run_10_plot_4way.out
#PBS -e /scratch/users/ntu/shuyan00/nscc_qwen/logs/run_10_plot_4way.err

set -euo pipefail

echo "[INFO] Host: $(hostname)"
echo "[INFO] Start: $(date)"

BASE=/scratch/users/ntu/shuyan00/nscc_qwen
PROJ=/home/users/ntu/shuyan00/scratch/nscc_qwen/basicquant
ENV=$BASE/conda_envs/qwen311_clean

PY=$BASE/run/10_plot_nav_compare_4way.py

NO_LLM=$PROJ/results/portfolio_nav.csv
LLM=$PROJ/results/portfolio_nav_llmweights.csv
LLM_BAYES=$PROJ/results/portfolio_nav_llmweights_bayes_ema.csv
LLM_BAYES_REGIME=$PROJ/results/portfolio_nav_llmweights_bayes_regime.csv

OUT_DIR=$PROJ/results
PREFIX=fig_4way
ROLL_WINDOW=52

echo "[INFO] PROJ=$PROJ"
echo "[INFO] ENV=$ENV"
echo "[INFO] PY=$PY"
echo "[INFO] NO_LLM=$NO_LLM"
echo "[INFO] LLM=$LLM"
echo "[INFO] LLM_BAYES=$LLM_BAYES"
echo "[INFO] LLM_BAYES_REGIME=$LLM_BAYES_REGIME"
echo "[INFO] OUT_DIR=$OUT_DIR PREFIX=$PREFIX ROLL_WINDOW=$ROLL_WINDOW"

module purge
module load gcc/11.4.0-nscc
source $BASE/apps/miniforge3/etc/profile.d/conda.sh
conda activate $ENV

# ensure matplotlib exists
python - << 'PY'
import importlib, sys
try:
    importlib.import_module("matplotlib")
    print("[INFO] matplotlib ok")
    sys.exit(0)
except Exception as e:
    print("[WARN] matplotlib missing:", e)
    sys.exit(1)
PY

if [ $? -ne 0 ]; then
  echo "[INFO] Installing matplotlib into env (one-time)..."
  conda install -y matplotlib
fi

# sanity checks
for f in "$PY" "$NO_LLM" "$LLM" "$LLM_BAYES" "$LLM_BAYES_REGIME"; do
  if [ ! -f "$f" ]; then
    echo "[FATAL] missing: $f"
    exit 2
  fi
done

cd $PROJ

echo "[INFO] Running 4-way plots..."
python "$PY" \
  --no_llm "$NO_LLM" \
  --llm "$LLM" \
  --llm_bayes "$LLM_BAYES" \
  --llm_bayes_regime "$LLM_BAYES_REGIME" \
  --out_dir "$OUT_DIR" \
  --prefix "$PREFIX" \
  --roll_window "$ROLL_WINDOW"

echo "[INFO] Done: $(date)"
echo "[INFO] Outputs:"
ls -lah $OUT_DIR | grep -E "fig_4way_|summary_4way.csv" || true